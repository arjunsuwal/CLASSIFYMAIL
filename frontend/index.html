<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Classifier & Response Generator</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>📧 Email Intelligence Assistant</h1>
            <p>Analyze emails and generate smart responses with AI</p>
        </header>

        <div class="main-content">
            <!-- Input Section -->
            <div class="input-section">
                <h2>📝 Email Input</h2>
                <form id="emailForm">
                    <div class="form-group">
                        <label for="subject">Subject:</label>
                        <input type="text" id="subject" name="subject" placeholder="Enter email subject..." required>
                    </div>
                    
                    <div class="form-group">
                        <label for="body">Email Body:</label>
                        <textarea id="body" name="body" rows="8" placeholder="Paste the email content here..." required></textarea>
                    </div>
                    
                    <button type="submit" class="analyze-btn" id="analyzeBtn">
                        <span class="btn-text">Analyze Email</span>
                        <div class="loading-spinner" id="loadingSpinner"></div>
                    </button>
                </form>
            </div>

            <!-- Results Section -->
            <div class="results-section" id="resultsSection" style="display: none;">
                <h2>🎯 Analysis Results</h2>
                
                <!-- Email Preview -->
                <div class="email-preview">
                    <div class="email-header">
                        <div class="email-subject">
                            <h3 id="previewSubject">Subject will appear here</h3>
                            <div class="urgency-badge" id="urgencyBadge">
                                <span id="urgencyText">MEDIUM</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="email-body-preview">
                        <p id="previewBody">Email body preview...</p>
                    </div>
                </div>

                <!-- Summary Section -->
                <div class="summary-section">
                    <h3>📋 Summary</h3>
                    <div class="summary-content" id="summaryContent">
                        Summary will appear here after analysis...
                    </div>
                </div>

                <!-- Reply Draft Section -->
                <div class="reply-section">
                    <h3>✉️ Generated Reply</h3>
                    <div class="reply-container">
                        <textarea id="replyDraft" rows="8" class="reply-textarea" placeholder="Reply will be generated here..."></textarea>
                        
                        <div class="reply-actions">
                            <button class="action-btn edit-btn" id="editSendBtn">
                                📝 Edit & Send
                            </button>
                            <button class="action-btn copy-btn" id="copyBtn">
                                📋 Copy Response
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Status Messages -->
            <div class="status-message" id="statusMessage"></div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast">
        <span id="toastMessage">Message copied to clipboard!</span>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:5000';

        // Form submission handler
        document.getElementById('emailForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const subject = document.getElementById('subject').value.trim();
            const body = document.getElementById('body').value.trim();
            
            if (!subject || !body) {
                showStatus('Please fill in both subject and body fields.', 'error');
                return;
            }

            await analyzeEmail(subject, body);
        });

        // Analyze email function
        async function analyzeEmail(subject, body) {
            const analyzeBtn = document.getElementById('analyzeBtn');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const btnText = document.querySelector('.btn-text');
            
            // Show loading state
            analyzeBtn.disabled = true;
            loadingSpinner.style.display = 'block';
            btnText.textContent = 'Analyzing...';
            
            showStatus('Processing your email...', 'info');

            try {
                const response = await fetch(`${API_BASE_URL}/process-email`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        subject: subject,
                        body: body
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                displayResults(subject, body, data);
                showStatus('Email analyzed successfully!', 'success');

            } catch (error) {
                console.error('Error:', error);
                showStatus('Error analyzing email. Please check if the backend server is running.', 'error');
            } finally {
                // Reset loading state
                analyzeBtn.disabled = false;
                loadingSpinner.style.display = 'none';
                btnText.textContent = 'Analyze Email';
            }
        }

        // Display results function
        function displayResults(subject, body, data) {
            // Show results section
            document.getElementById('resultsSection').style.display = 'block';
            
            // Update email preview
            document.getElementById('previewSubject').textContent = subject;
            document.getElementById('previewBody').textContent = body.substring(0, 200) + '...';
            
            // Update urgency badge
            const urgencyBadge = document.getElementById('urgencyBadge');
            const urgencyText = document.getElementById('urgencyText');
            urgencyText.textContent = data.urgency.toUpperCase();
            
            // Set urgency badge color
            urgencyBadge.className = 'urgency-badge urgency-' + data.urgency.toLowerCase();
            
            // Update summary
            document.getElementById('summaryContent').textContent = data.summary;
            
            // Update reply draft
            document.getElementById('replyDraft').value = data.reply;
            
            // Scroll to results
            document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
        }

        // Copy to clipboard function
        document.getElementById('copyBtn').addEventListener('click', function() {
            const replyText = document.getElementById('replyDraft').value;
            
            if (replyText.trim() === '') {
                showToast('No reply to copy!');
                return;
            }
            
            navigator.clipboard.writeText(replyText).then(function() {
                showToast('Reply copied to clipboard!');
            }, function(err) {
                showToast('Failed to copy reply');
                console.error('Could not copy text: ', err);
            });
        });

        // Edit & Send button handler
        document.getElementById('editSendBtn').addEventListener('click', function() {
            const replyText = document.getElementById('replyDraft').value;
            
            if (replyText.trim() === '') {
                showToast('No reply to edit!');
                return;
            }
            
            // Create mailto link
            const subject = document.getElementById('previewSubject').textContent;
            const mailtoLink = `mailto:?subject=Re: ${encodeURIComponent(subject)}&body=${encodeURIComponent(replyText)}`;
            
            window.open(mailtoLink);
            showToast('Opening email client...');
        });

        // Status message function
        function showStatus(message, type) {
            const statusElement = document.getElementById('statusMessage');
            statusElement.textContent = message;
            statusElement.className = `status-message ${type}`;
            statusElement.style.display = 'block';
            
            setTimeout(() => {
                statusElement.style.display = 'none';
            }, 5000);
        }

        // Toast notification function
        function showToast(message) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            
            toastMessage.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Auto-resize textarea
        document.getElementById('body').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = this.scrollHeight + 'px';
        });

        document.getElementById('replyDraft').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = this.scrollHeight + 'px';
        });
    </script>
</body>
</html>